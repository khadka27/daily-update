name: ðŸ“… Daily Commit

# Grant the Actions token permission to push commits
permissions:
  contents: write
  actions: read

on:
  schedule:
    - cron: "15 18 * * *" # 18:15 UTC â†’ 00:00 NPT
  workflow_dispatch:

jobs:
  commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # ensure the GITHUB_TOKEN is configured for git push
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install ts-node
        run: npm install -g ts-node typescript

      - name: Configure Git user
        run: |
          git config user.name "khadka27"
          git config user.email "abishekkhadka90@gmail.com"

      - name: Generate and commit journal entry
        run: |
          #!/usr/bin/env bash

          # Write the inline TypeScript script
          cat > generate_content.ts << 'EOF'
          import { writeFileSync, mkdirSync, existsSync } from 'fs';

          const quotes = [
            "The best way to predict the future is to create it.",
            "Code is like humor. When you have to explain it, it's bad.",
            "The only way to do great work is to love what you do.",
            "Programming isn't about what you know; it's about what you can figure out.",
            "The most damaging phrase in the language is 'We've always done it this way.'"
          ];

          const topics = [
            "Web Development", "Machine Learning", "Cloud Computing",
            "DevOps", "Mobile Development", "Data Science",
            "Cybersecurity", "Blockchain", "UI/UX Design",
            "API Development", "Database Management", "System Architecture"
          ];

          const goals = [
            "Implement new feature", "Refactor existing code",
            "Write unit tests", "Update documentation",
            "Fix bugs", "Optimize performance",
            "Learn new technology", "Review pull requests",
            "Plan architecture", "Deploy updates"
          ];

          function sample<T>(arr: T[], n: number): T[] {
            const copy = [...arr];
            const out: T[] = [];
            for (let i = 0; i < n; i++) {
              const idx = Math.floor(Math.random() * copy.length);
              out.push(copy.splice(idx, 1)[0]);
            }
            return out;
          }

          function main() {
            // YYYY-MM-DD
            const dateStr = new Date().toISOString().split('T')[0];
            const q      = quotes[Math.floor(Math.random() * quotes.length)];
            const tps    = sample(topics, 3);
            const gls    = sample(goals, 3);

            let md  = `# Journal Entry: ${dateStr}\n\n> ${q}\n\n`;
                md += "## Today's Focus\n" + tps.map(t => `- ${t}`).join('\n') + '\n\n';
                md += "## What I Learned\n";
                md += `- Explored new concepts in ${tps[0]}\n`;
                md += `- Improved understanding of ${tps[1]}\n`;
                md += `- Gained insights into ${tps[2]}\n\n`;
                md += "## Tomorrow's Goals\n" + gls.map(g => `- ${g}`).join('\n') + '\n\n';
                md += `---\n*This entry was automatically generated by GitHub Actions.*\n`;

            const dir = 'journals';
            if (!existsSync(dir)) mkdirSync(dir);
            writeFileSync(`${dir}/journal-${dateStr}.md`, md);
          }

          main();
          EOF

          # Run it
          ts-node generate_content.ts

          # Stage & commit (allow empty so job never fails)
          CURRENT_DATE=$(date -u +'%Y-%m-%d')
          git add journals/journal-"$CURRENT_DATE".md
          git commit -m "feat: add journal entry for $CURRENT_DATE" || \
            git commit --allow-empty -m "chore: daily automated commit $CURRENT_DATE"

      - name: Push changes
        run: git push origin main
