name: ðŸ“… Daily Commit

permissions:
  contents: write
  actions: read

on:
  schedule:
    - cron: "15 18 * * *" # 18:15 UTC â†’ 00:00 NPT
  workflow_dispatch:

jobs:
  commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: Fix remote origin
        run: |
          git remote set-url origin https://${{ secrets.GITHUB_TOKEN }}@github.com/khadka27/daily-update.git

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install ts-node
        run: npm install -g ts-node typescript

      - name: Configure Git user
        run: |
          git config user.name "khadka27"
          git config user.email "abishekkhadka90@gmail.com"

      - name: Generate and commit journal entry
        run: |
          #!/usr/bin/env bash
          cat > generate_content.ts << 'EOF'
          import { writeFileSync, mkdirSync, existsSync } from 'fs';

          const quotes = [
              "The best way to predict the future is to create it.",
              "Code is like humor. When you have to explain it, it's bad.",
              "The only way to do great work is to love what you do.",
              "Programming isn't about what you know; it's about what you can figure out.",
              "The most damaging phrase in the language is 'We've always done it this way.'"
          ];

          const topics = [
              "Web Development", "Machine Learning", "Cloud Computing",
              "DevOps", "Mobile Development", "Data Science",
              "Cybersecurity", "Blockchain", "UI/UX Design",
              "API Development", "Database Management", "System Architecture"
          ];

          const goals = [
              "Implement new feature", "Refactor existing code",
              "Write unit tests", "Update documentation",
              "Fix bugs", "Optimize performance",
              "Learn new technology", "Review pull requests",
              "Plan architecture", "Deploy updates"
          ];

          // Helper function to get a random element from an array
          function getRandomElement<T>(arr: T[]): T {
              return arr[Math.floor(Math.random() * arr.length)];
          }

          // Helper function to get n random elements from an array
          function getRandomSample<T>(arr: T[], n: number): T[] {
              const shuffled = [...arr].sort(() => 0.5 - Math.random());
              return shuffled.slice(0, n);
          }

          function main() {
            const date = new Date();
            const dateStr = date.toISOString().split('T')[0];
            const quote = getRandomElement(quotes);
            const selectedTopics = getRandomSample(topics, 3);
            const selectedGoals = getRandomSample(goals, 3);

            const md = `# Journal Entry: ${dateStr}\n\n> ${quote}\n\n## Today's Focus\n\${selectedTopics.map(topic => \`- ${topic}\`).join('\\n')}\n\n## What I Learned\n- Explored new concepts in ${selectedTopics[0]}\n- Improved understanding of ${selectedTopics[1]}\n- Gained insights into ${selectedTopics[2]}\n\n## Tomorrow's Goals\n\${selectedGoals.map(goal => \`- ${goal}\`).join('\\n')}\n\n---\n*This entry was automatically generated by GitHub Actions.*`;

            const dir = 'journals';
            if (!existsSync(dir)) {
                mkdirSync(dir, { recursive: true }); // Use recursive: true for nested directories
            }
            writeFileSync(`${dir}/journal-${dateStr}.md`, md);
          }

          main();
          EOF

          ts-node generate_content.ts

          CURRENT_DATE=$(date -u +'%Y-%m-%d')
          git add journals/journal-"$CURRENT_DATE".md
          git commit -m "feat: add journal entry for $CURRENT_DATE" || \
            git commit --allow-empty -m "chore: daily automated commit $CURRENT_DATE"

      - name: Push changes
        run: git push origin main
